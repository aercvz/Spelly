local players = game:GetService("Players")
local httpService = game:GetService("HttpService")
local collectionService = game:GetService("CollectionService")
local runService = game:GetService("RunService")

local player = players.LocalPlayer
local character, head, torso, hilt

local function character_added()
	character = player.Character
	head = character:WaitForChild("Head")
	torso = character:WaitForChild("Torso")
	hilt = character:WaitForChild("Hilt")
end
local function character_removed()
	character = nil
	head = nil
	torso = nil
	hilt = nil
end

character_added()
player.CharacterAdded:Connect(character_added)
player.CharacterRemoving:Connect(character_removed)

--# config

local config = "settings.spelly"

local default = {
	["menuKeybind"] = Enum.KeyCode.RightControl.Name,
	["antiAAGun"] = false
}

local settings

if not pcall(function() readfile(config) end) then
	writefile(config, httpService:JSONEncode(default))
end

settings = httpService:JSONDecode(readfile(config))

local function saveSettings()
	writefile(config, httpService:JSONEncode(settings))
end

local function changeValue(setting, value)
	settings[setting] = value
	writefile(config, httpService:JSONEncode(settings))
end

--#

--# notifications

local notifLibrary = loadstring(game:HttpGet("https://raw.githubusercontent.com/Kinlei/Dynissimo/main/Scripts/AkaliNotif.lua"))()
local notifyFunction = notifLibrary.Notify

local function notify(title, text, dur)
	notifyFunction({
		Description = text;
		Title = title;
		Duration = dur
	})
end

--#

--# modules

local function apply_antiGun(weapon)
	local propWeld = weapon:WaitForChild("PropWeld")
	propWeld.Part0 = torso
	propWeld.C1 = CFrame.new(1, 3, 0)
	local listener; listener = runService.RenderStepped:Connect(function()
		if weapon == nil or weapon.Parent == nil then
			listener:Disconnect()
			listener = nil
		end
		propWeld.C0 *= CFrame.Angles(0, 2, 0)
	end)
end

hilt.ChildAdded:Connect(function(v)
	if settings["antiAAGun"] == true then
		apply_antiGun(v)
	end
end)

--#

--# library

local library = loadstring(game:HttpGet("https://raw.githubusercontent.com/insanedude59/SplixUiLib/main/Main"))()
local window = library:new({
	textsize = 13.5,
	font = Enum.Font.RobotoMono,
	name = "Spelly HUB",
	color = BrickColor.Random().Color,
	key = Enum.KeyCode[default["menuKeybind"]]
})

local tab = window:page({
	name = "Main"
})
local section = tab:section({
	name = "Misc",
	side = "left",
	size = 150
})
section:toggle({
	name = "Anti AA-Gun",
	def = default["antiAAGun"],
	callback = function(value)
		changeValue("antiAAGun", value)
		if value == true then
			local weapon = hilt:FindFirstChildWhichIsA("MeshPart")
			if not weapon then
				notify("spelly", "an equipped weapon is required for this module", 2.5)
			else
				apply_antiGun(weapon)
			end
		end
	end,
})
section:button({
	name = "Headless",
	callback = function()
		if not collectionService:HasTag(character, "Knocked") then
			notify("spelly", "headless requires you to be ragdolled in order to use it", 2.5)
		else
			head:Destroy()
		end
	end,
})
section:keybind({
	name = "Menu Keybind",
	def = default["menuKeybind"],
	callback = function(key)
		print(key)
		changeValue("menuKeybind", key.Name)
		window.key = key
	end,
})

--#
